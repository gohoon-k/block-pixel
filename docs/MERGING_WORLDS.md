# Pixel - version control with Minecraft
이 문서는 마인크래프트 pixel 플러그인의 평행세계를 합치는 동작에 대해 설명합니다.  
본 README.md 문서는 [여기](/README.md)입니다.  
  
_*본 문서는 [이 문서](/docs/BRANCH_AND_CHECKOUT.md)를 먼저 읽어보시면 도움이 될 수 있습니다._

## 이 문서의 내용
[평행세계 합치기](#평행세계-합치기)  
[평행세계를 합치는 과정](#평행세계를-합치는-과정)  
[꼭 합쳐야하나?](#꼭-합쳐야하나)

## 평행세계 합치기
가끔, 평행세계 두 개를 만들었는데 둘 다 괜찮아서 하나의 월드로 합치고 싶을 때가 있을 수 있습니다.  
그럴 때는 `/pixel merge` 명령을 통해 평행세계를 합치면 됩니다.  
  
예를 들어 'structure'라는 세계를 내가 있는 세계로 합치고싶다고 한다면 다음처럼 수행합니다.  

`/pixel merge overworld structure keep true`  
  
이 때 `keep`은 두 월드 모두에서 변경된, 그러니까 두 월드에 서로 다른 블럭이 있을 경우 어느 것을 존중할지에 대한 값입니다. `keep`은 현재 월드의 것을, `replace`는 지금 세계에 합쳐질 세계의 것을 존중합니다. 

다만, 합치는 알고리즘이 완벽하지 않고 월드의 전체 데이터 중 일부 데이터만 합치기 때문에 마인크래프트 월드 내에서 맵의 일관성이 무너질 수 있습니다.  
따라서 사용할 때에는 **월드가 망가질 위험을 감수하고 사용**해야합니다.  
물론, 이 사항도 버전관리가 진행되므로 합친 후 자동으로 백업시점을 만들며, 만약 합친 결과물이 마음에 들지 않으면 `/pixel reset` 커맨드를 통해 시간을 되돌려 변경사항을 제거할 수 있습니다.  
  
얼마든지 뒤로 되돌릴 수 있도록 설계되어있지만, 병합 기능을 사용하려 하신다면 아래의 내용을 주의깊게 읽고, 어떤 결과가 나올지 미리 예측을 한 후에 사용하시는 것을 추천합니다.

## 평행세계를 합치는 과정
두 평행세계를 합치려면 세 개의 시점이 필요합니다. 각각 **지금 자신이 포함되어있는 평행세계의 가장 최근 시점**, **합치려는 평행세계의 가장 최근 시점**, **두 평행세계가 갈라지기 시작한 기점이 되는 시점**입니다.  
_*사실 Git에서는 이것을 '병합'이라 부르고, 병합은 평행세계를 대상으로 진행되기도 하지만 백업 지점을 대상으로 진행되기도 합니다. 아직 pixel 플러그인은 평행세계를 대상으로만 진행하고 있기 때문에, 이 문서에서는 그렇게 서술합니다._  
  
편의상 첫 번째 시점을 A('master'라는 평행세계의 시점), 두 번째 시점을 B('structure'라는 평행세계의 시점), 세 번째 시점을 O라고 하고, B를 A로 `replace`모드를 사용해 합친다고 하겠습니다.  
그러면 명령은 다음과 같은 모습이 됩니다.  
`/pixel merge overworld structure replace true`  
  
이 명령은 풀어서 설명하면 다음과 같습니다.  
'master'와 'structure' 라는 세계를 합치는데, 그 기록을 'master' 세계에 남기고, `replace`모드를 사용할거야.  
  
모드가 뭐냐구요? 지금부터 살펴볼게요.  

병합을 진행하려면 O 시점을 기준으로 각 세계에서 만들어진 변경점을 찾아야합니다.  
두 쪽 모두 변경사항이 없다면(O=A, O=B), 그대로 둡니다.  
한 쪽에서만 변경되었다면(O=A 이고 O!=B, 혹은 O!=A 이고 O=B) 변경된 사항을 결과가 될 세계에 반영합니다.  
그러나 같은 요소에 대해 두 세계 모두에서 변경된 사항이 있다면(O!=A!=B), 그 때는 둘 중 하나를 선택해서 반영해야합니다. 이 때 사용하는 인수가 '모드' 인수입니다.  

같은 요소에 의해 두 평행세계 모두에서 변경사항이 만들어졌을 때,  
`keep` 모드를 사용해 병합했을 경우 A의 사항을 **존중**합니다.
즉, A의 사항을 남기고 B의 사항은 삭제합니다.  
`replace` 모드를 사용해 병합하면 반대로, B의 사항을 **존중**하고 A의 사항을 삭제합니다.  
  
잘 모르시겠다면, 아래의 예시를 하나씩 읽어보세요.  

### 블럭(지형)의 병합
두 평행세계의 세 위치 (0, 0, 0), (5, 5, 5), (10, 10, 10)가 있다고 합시다.  
그리고 두 평행세계가 갈라지기 시작했을 때는, 세 위치의 블럭이 모두 '흙' 이었다고 가정하겠습니다.  
그리고 새로운 두 평행세계가 만들어져 다음과 같은 변경사항이 생겼습니다.
- A 세계에서 (0, 0, 0)을 '조약돌'로 변경하고, (5, 5, 5)를 '상자'로 바꿨습니다.
- B 세계에서 (0, 0, 0)을 '이끼낀 조약돌'로 변경했습니다.

그러면 병합이 이렇게 진행됩니다.  
- (10, 10, 10) 위치는 두 세계 모두에서 변경사항이 생기지 않았습니다. 이전 값(흙)을 그대로 사용합니다.  
- (5, 5, 5) 위치는 두 세계 중 A 세계에서만 변경되었습니다. 변경된 값(상자)을 사용합니다.
- (0, 0, 0) 위치는 두 세계 모두에서 변경되었습니다. 모드가 `replace` 이므로, B를 존중해 B의 값(이끼낀 조약돌)을 사용하고 A의 값(조약돌)은 삭제합니다.

최종적으로 병합이 끝나면 (0, 0, 0), (5, 5, 5), (10, 10, 10) 위치에는 각각 '이끼낀 조약돌', '상자', '흙'이 존재하게 됩니다.

### 엔티티의 병합
엔티티의 병합은 큰 과정은 비슷하지만, 다른 사항이 약간 있습니다.  
블럭은 월드의 모든 좌표에 모두 고정된 값이 있는 형태이지만, 엔티티는 있을 수도 있고 없을 수도 있는 요소이기 때문입니다.  

그래서 엔티티의 경우 변경사항 확인을 다음과 같이 **엔티티의 UUID를 기준으로한 존재 여부**로 수행합니다.  
두 평행세계가 갈라지기 시작했을 때는 a 라는 엔티티와 b 라는 엔티티, c 라는 엔티티가 있었다고 합시다.
그리고 새로운 두 평행세계가 만들어져 다음과 같은 변경사항이 생겼습니다.
- A세계에서 b가 죽고 d라는 엔티티가 생겨났습니다.
- B세계에서 a, b가 죽었습니다.
- 정말 희귀한 확률이지만, 서로 같은 엔티티 e가 A, B세계에서 모두 생겨났습니다.  

그러면 병합이 이렇게 진행됩니다.
- a는 B에서는 죽고, A에서는 생존했습니다. 그러나 병합 모드가 `replace`이므로, B의 사항을 존중해 병합 결과 세계에는 a가 포함되지 않습니다.  
- b는 두 세계 모두에서 죽었습니다. 둘 다 죽었으므로 당연히 병합 결과 세계에는 b가 포함되지 않습니다. 
- c는 존재 여부에 대한 변경사항이 없습니다. 다만, 병합 모드가 `replace`이므로, 병합 결과 세계에는 B의 c가 포함됩니다.  
- d는 한쪽에서만 생겨났습니다. 병합 결과 세계에 A의 d가 포함됩니다.
- e는 일반적인 경우 일어나지 않습니다. 새로 생성된 엔티티에 대해 서로 같은 UUID가 부여될 확률은 정말 정말 매우 낮으며, 그럼에도 같은 엔티티가 생겨났을 경우 병합 모드가 `replace`이므로 B의 e가 병합 결과 세계에 포함됩니다.

최종적으로 병합이 끝난 세계에는 B의 c, A의 d, B의 e가 포함됩니다.  
다시말해, 서로 같은 엔티티에 대해서는 그 내용이 병합되지 않고 둘 중 하나만 선택한다는 뜻입니다.

### 주민의 병합
주민이라는 엔티티는 그 엔티티 자체가 특정 블록과 상호작용하는 특수한 엔티티입니다.  
엔티티의 정보에 그 상호작용하는 블록의 정보가 저장되어있고, poi 라는 파일에 어떤 블록이 이미 다른 엔티티에게 차지되었는지에 대한 내용이 저장되어있습니다.  
  
이런 엔티티의 병합은 일반적인 경우 기존 세계의 것을 존중하지만, 다음처럼 되는 경우도 있습니다.  
두 평행세계가 갈라지기 시작했을 때는 특정 위치에 지도제작대 X가 있었고, 어떤 주민도 X를 차지하지 않은 상태였습니다.
그리고 새로운 두 평행세계가 만들어져 다음과 같은 변경사항이 생겼습니다.
- A 세계의 주민 a가 X를 차지했습니다.
- B 세계의 주민 b가 X를 차지했습니다.

서로 다른 주민이 다른 평행세계에서 서로 같은 지도제작대를 차지한 경우입니다.  
그리고, a와 b가 서로 다른 요소에 의해 병합에서 제외되거나 하지 않고 모두 병합된 세계에 포함되었다면 다음과 같이 병합됩니다.  
- 병합 모드가 `replace` 이므로, B의 사항을 존중해 A세계의 주민 a는 직업을 잃고, B세계의 주민 b가 지도제작대 X를 차지합니다.  

물론 지도제작대와 지도제작자에만 해당되는 사항이 아니며, 모든 주민 직업에 해당하는 블록 및 침대에 해당하는 사항입니다.  
  
다만, 주민과 상호작용하는 블럭 중에는 마을 중심에 존재하는 '종(bell)' 블럭도 있는데, meeting_point 라는 이름을 가지는 값과 관련이 있습니다.    
이 값은 임의로 병합하기 어렵고, 주민의 시스템에 크게 영향을 주지 않는다고 판단하여 병합 시 모든 주민의 meeting_point 값을 제거합니다.

## 꼭 합쳐야하나?
이런 생각이 드신다면, 안쓰시는게 좋습니다. 아마도요.  
원하는 결과가 나오지 않을 가능성도 있고, 병합 자체도 월드가 크면 클수록 걸리는 시간이 늘어납니다.  
당연히 병합을 쓰지 않아도 버전관리에는 문제가 없습니다. 다만, 평행세계를 즐겨 만드신다면 언젠가 하나정도 합치고싶은 두 평행세계가 나올 확률은 좀 있는 편이겠죠.  
  
첫 문단에서도 언급했지만, 이 기능은 사용에 주의해야 합니다.